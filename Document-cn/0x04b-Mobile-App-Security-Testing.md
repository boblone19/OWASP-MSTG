## 移动应用安全 测试

在以下章节中, 我们会简单的概述安全测试原则 和 关键技术术语. 在这里介绍的大部分定义和其他对渗透测试的解读是相似的, 如果你是经验丰富的安全测试员, 很多内容也许你已经很熟悉了.

整个指南中, 我们用 "移动 应用 安全测试" 这个综合名词来代表移动应用安全的静态分析和动态分析. 类似于 "移动应用渗透测试" 和 "移动应用安全分析" 某种程度上常用在安全领域中, 但是这些定义基本上都是指的同一件事情. 移动应用安全测试 通常是大规模的安全评估 或者 渗透测试, 这些测试包含了客户端到服务器端的架构, 以及服务器端 API 被移动应用的调用.

在这个指南中, 我们包含移动应用安全测试的两种不同背景. 第一个种是 "经典/传统" 安全测试, 发生在开发生命周期快完成的时候. 在这种背景下, 测试人员访问几乎完成或者准备投入生产的应用程序版本, 识别安全问题, 并编写报告 (通常是具有破坏性的危害). 另外一种环境背景是, 软件需求的实现是从软件开发生命周期开始, 即安全自动化流程中开始. 在两种情况下, 基本需求和测试案例都适用, 只是高级方法和客户端交互的级别不同.

### 测试基本原理

#### 白盒测试 对比 黑盒测试

让我们来定义这些概念:

- **黑盒 测试** 指测试人员没有任何关于正在测试的应用程序的信息的情况下进行的. 这种测试有时候被称为 "零信息测试". 这个测试的主要目的是让测试人员模拟真正的攻击者的思维一样, 探索可用的和可发现的信息.
- **白盒 测试** (有时被称为 "了如指掌测试") 与黑箱测试完全相反，因为测试人员完全了解应用程序。这些知识可能包括源代码、文档和图表。这种方法允许比黑盒测试快得多的测试，因为它是透明的，并且利用获得的额外知识，测试人员可以构建更复杂和粒度更细的测试用例。
- **灰盒 测试** 是介于上述两种测试类型之间的测试: 一些信息提供给测试人员(通常仅提供凭证)，而其他信息则被用来发现。这种类型的测试在测试用例的数量、成本、速度和测试范围方面是一种有趣的折衷。灰箱测试是安全行业中最常见的一种测试。

我们强烈建议您使用源代码，以便尽可能有效地使用测试时间。测试人员获取代码访问显然不会模拟外部攻击，但是它简化了漏洞的识别，允许测试人员在代码级别验证每个识别出的异常或可疑行为。如果应用程序之前没有测试过，那么可以使用白盒测试。

尽管在Android上进行反编译非常简单，但是源代码可能会被混淆，而消除混淆将非常耗时。因此，消除时间限制是测试人员访问源代码的另一个原因。

#### 漏洞 分析

漏洞分析通常是在应用程序中寻找漏洞的过程。虽然这可能是手工完成的，但通常使用自动扫描来识别主要的漏洞。静态分析和动态分析是脆弱性分析的常见两种类型。

#### 静态 对比 动态 分析

静态应用程序安全性测试(SAST)即通过手动或自动分析源代码，在不执行组件的情况下检查应用程序的组件。
OWASP 提供了关于 [静态代码分析](https://www.owasp.org/index.php/Static_Code_Analysis "OWASP 静态代码分析") 这些信息可以帮助您了解技术、优势、弱点和限制。

动态应用程序安全性测试(DAST)涉及在运行时检查应用程序。这种分析可以是手动的，也可以是自动的。它通常不提供静态分析提供的信息，但是从用户的角度来看，它是检测感兴趣组件(资产、功能、入口点等)的好方法。

交互式应用程序安全性测试(IAST)通过软件工具进行安全测试，或者使用工具在应用程序运行时监视它，并收集关于它的功能和执行方式的信息。

既然我们已经定义了静态和动态分析，让我们更深入地研究一下。

#### 静态 分析

在静态分析期间，对移动应用程序的源代码进行审查，以确保安全适当控制的实现。在大多数情况下，使用自动/手动的混合方法。自动扫描抓住了容易实现的问题，手动测试人员可以根据上下文的代码在头脑中搜索特定的问题。

##### 人工/手动 代码审核

测试人员通过手动代码审查, 手动分析移动应用程序的源代码, 从而检查安全漏洞。方法通过 'grep' 命令进行基本的关键字搜索到逐行检查源代码。ide(集成开发环境)通常提供基本的代码审查功能，可以使用各种工具进行扩展。

人工代码分析的一种常见方法是识别关键安全漏洞标识, 通常就是搜索特定 API 和 关键字, 例如 数据库相关的方法调用 "executeStatement" 或者 "executeQuery". 代码含有这些字符串是开始人工分析良好起点.

相对于自动化代码分析, 手动代码审核对于识别业务逻辑中的漏洞, 违反标准, 和设计弱点, 特别是代码从技术上是安全的, 但是逻辑上存在弱点的等情况有很好的帮助.

手动代码审查需要一个代码审核专家, 而且需要对编译语音的熟悉和移动应用框架的熟悉. 完整的代码审核是漫长的, 乏味的, 耗时的, 特别是对于大型代码应用存在多种其他软件依赖. 

##### 自动 源代码分析

自动分析工具能够提高审核静态应用安全测试的速度(SAST). 它们通过已经定义好的规则或者业界最佳实践来检查源代码, 然后显示一系列检查结果和警告,并且标识所有被检测的违规软件行为. 某些静态分析工具只支持能够编译的应用, 某些必须关联源代码一起, 还有些运行实时分析插件在集成开发环境中(IDE).

虽然某些静态代码分析工具包含了很多关于规则信息和编译语音要求来分析移动应用, 但是仍然会产生很多误报, 特别是如果他们和目标环境配置不一样的时候. 一位安全专家必须介入来分析这些结果.

附录“测试工具”包括一个静态分析工具列表，可以在本书的最后部分找到

#### 动态 分析

DAST 的重点是通过应用程序的实时执行对其进行测试和评估。动态分析的主要目标是发现程序运行时的安全漏洞或弱点。在移动平台层和后端服务和api之间进行动态分析，可以分析移动应用程序的请求和响应模式。

动态分析通常用于检查安全机制，以提供足够的保护来抵御最常见的攻击类型，如传输中的数据公开、身份验证和授权问题以及服务器配置错误。

#### 过滤 误报

##### 自动 扫描工具

自动测试工具的挑战, 是缺乏对应用内容的准确度. 换句话来说,这些工具能够识别潜在的不相关的问题. 这种结果我们通常称之为 "误报". 

举例, 安全测试常报告的发生在网页浏览器中的漏洞不一定和移动应用相关联. 误报发生的原因是因为自动工具基于一般浏览器为主的网页应用,来扫描后端服务. 比如说 CSRF (跨站请求伪造) 和 跨站脚本 (XSS) .

让我们拿 CSRF 来举例. 一个成功的 CSRF 攻击需要以下条件:

- 诱骗已经登录的用户通过网页浏览器打开可疑的链接, 从而访问有漏洞的站点. 
- 客户端浏览器必须将会话 cookie 或者其他认证令牌自动添加到请求中.

然而移动应用无法满足这些要求: 及时WebView 和 基于令牌的会话管理被使用, 任何可以链接被用户通过默认浏览器打开的行为, cookie 实际都是额外存放. 

如果应用存在了 WebView 的功能, 存在跨站脚本的可能是一个问题, 因为只有在应用程序导出JavaScript接口时, 才有可能执行命令. 然而, 由于上面提到的原因, 跨站脚本很少成为可利用的攻击点(是否应该存在就是有争议的 — 输出转义是最佳实践).

> 在任何情况下, 当你进行风险评估的时候,应该考虑到渗透场景; 不要盲目的相信你的扫描工具的结果.

##### 剪切板

当你输入数据到输入栏, 剪切板可以用来拷贝数据. 剪切板可以通过系统整个系统来访问,所以与应用共享. 这种共享机制可以被可以应用程序利用来获取保存在剪切板中的敏感信息.

在 iOS 版本 9之前, 某种可疑的应用可以在后台背景监控复制板, 并且周期性的获取当中的数据.a `[UIPasteboard generalPasteboard].string`. 自从 iOS 9 之后, 剪贴板内容只能被前台的应用程序访问, 这样大大的减少了从剪贴板嗅探密码的攻击面.

对于 [Android 有一个 PoC 漏洞发布](https://arstechnica.com/information-technology/2014/11/using-a-password-manager-on-android-it-may-be-wide-open-to-sniffing-attacks/ "密码 嗅探") 为了掩饰如果密码被保存在剪贴板中的攻击方式. [屏蔽在输入框粘贴密码功能](https://github.com/OWASP/owasp-masvs/issues/106 "屏蔽在输入框粘贴密码功能") 是 MASVS 1.0 中的要求之一, 但是最终被移除了,因为以下原因:

- 屏蔽粘贴数据到应用的输入框,并不能防止用户拷贝任何敏感信息. 由于信息在用户发现无法使用粘贴功能之前就已经被复制率, 此时,一个恶意的应用程序已经嗅探到了剪切板中的内容.
- 如果密码输入框的粘贴功能被禁用, 用户为了容易技术密码,从而使用较弱的密码, 他们从此不会再使用密码管理器, 这样将与我们为了让应用更加安全的初衷相违背.

当你使用应用的时候, 你应该注意其他应用正在读取你剪切板内容, 比如说 [Facebook 应用](https://www.thedailybeast.com/facebook-is-spying-on-your-clipboard "Facebook 在监听你的剪切板"). 尽管如此, 复制黏贴密码是一个安全风险, 你应该意识到, 但也不能通过一个应用程序功能来解决.

#### 渗透测试 (a.k.a. Pentesting)

传统的方式是在应用程序的最终或接近最终构建的阶段进行安全测试, 例如.,在开发过程结束时可用的构建. 为了在开发过程的最后进行测试, 我们建议使用 [移动应用安全验证标准 (MASVS)](https://github.com/OWASP/owasp-masvs "OWASP MASVS") 和相关的检查清单作为测试的基线, 一个经典的安全测试结构如下:

- **准备(Preparation)** - 定义安全测试的范围, 包括确定使用的安全控制, 组织和测试目标和敏感数据. 更粗略的来说, 准备工作包括与客户端的所有同步, 以及在法律上保护测试人员 (通常是第三方).请记住在很多国家, 未经书面授权的攻击系统是非法的!
- **情报收集(Intelligence Gathering)** - 分析 **环境** 和 **架构** 应用的内容来获取对应用内容上的理解.
- **综合应用功能分析(Mapping the Application)** - 根据上个阶段获取的信息; 通过自动扫描和手动探索应用程序来补充更多信息. 信息映射提供了对应应用程序, 入口点, 所保存的数据内容, 以及主要的潜在漏洞. 然后可以根据这些漏洞可能造成的损害对它们进行排序, 以便于安全测试人员对它们进行优先级处理. 此阶段包含了测试执行期间, 可能使用的测试用例的创建.
- **利用(Exploitation)** - 在这个阶段, 安全测试人员试图利用上个阶段发现的漏洞来渗透应用程序. 这个阶段对于确定漏洞是否真实存在和正确报警的必要性.
- **汇报(Reporting)** - 在这个阶段, 对于客户来说也是关键,安全测试汇报发现的漏洞,以及他能够利用的漏洞, 并且记录下他能够实现的危害,包括危害范围. (举例, 测试员可以非法的访问数据).

##### 准备

被测试的应用安全级别必须在测试之前被确定. 安全要求需要在项目开始之前被确定. 不同的组织有不同的安全要求,以及能够调用资源来进行测试活动. 虽然 MASVS 级别 1 控制适用于所有的移动应用,与技术和业务人员一起审阅整个 L1 和 L2 MASVS 控制的列表是确定安全测试覆盖级别的最好方法. 

在某些领域中,不同企业组织有着不同的要求和法务责任. 尽管应用不处理敏感数据, 一些 L2 的要求也可能是相关联的 (因为行业法规或者当地法律). 例如, 双因素认证(2FA)可能是金融应用程序必须的,并由国家的中央银行和/或金融监管机构强制执行.

在开发流程的早期中,安全目标/管控可以与项目股东商量以及评审. 某些控制可能符合 MASVS 控制, 但是其他可以根据组织或者应用来特殊定义.

![Preparation](Images/Chapters/0x03/mstg-preparation.png)

所有参与的团队必须就检查列表中的条目达成一致, 因为这定义了所有安全测试的基线.

###### 与 客户的协调

搭建一个工作的测试环境是一种挑战的任务. 举例, 企业无线访问点的限制和网络访问限制可能阻碍在客户地方进行动态分析测试. 公司策略也许会阻止使用越狱过的手机(硬件 和 软件) 或者在企业网络中使用测试工具. 使用了越狱监测和其他反逆向工程对策的应用会增加分析的工作量.

安全测试包括许多入侵任务, 包括监控和串改移动应用的网络流量, 监听应用数据文件, 以及插装 API 调用. 安全控制, 比如证书绑定 和 越狱监测机制 可能会妨碍这些任务, 并且极大的降低测试的速度.

为了克服这些障碍, 你可能需要向开发团队申请两个不同的应用程序. 一个应该是发布的版本, 这样你就可以确定现实的控制是否工作正常, 并且不能轻易的绕过他们. 第二种变体应该是某个安全控制以及被停用的调试版本. 测试2个不同的架构的应用是覆盖所有测试用例的最有效的方法.

根据约定的范围, 这种方法也许不行. 请求白盒测试生产和调试架构将帮助您完成所有的测试用例, 并清楚的说明了应用程序的安全成熟度. 客户可能更喜欢将黑盒测试集中在生产环境下的应用程序以及安全控制有效性的评估上.

两种不同测试的范应该在准备阶段讨论. 列如, 在测试之前, 安全控制是否需要调整. 更多的标题将会在下面讨论.

###### 识别 敏感数据

不同的行业和国家,对于敏感信息的分类不同. 此外, 组织可能对敏感数据采取限制性的观点, 并且他们可能有明确定义敏感信息好的数据,以及分类的策略.

数据可以从以下三种状态获得:

- **在保存的时候** - 数据存放在文件或者数据存储介质中
- **在使用的时候** - 应用数据将数据加载到其他介质中
- **在传输的时候** - 数据在移动应用和终端之间交换,或者在设备上消耗进程. 举例., 在 IPC 期间(Inter-Process Communication)

对每个地域的审查程度取决于数据的重要性和被访问的可能性. 列如, 应用程序内存中的数据可能比 Web 服务器上的数据更容易通过 core dump 的方式访问, 因为攻击者更有可能获取移动设备的物理访问权限, 而不是网页访问服务器.

如果没有可用的数据分类策略, 请使用以下通常被认为是敏感的信息列表:

- 用户认证信息 (认证凭证, PINs, etc.)
- 个人身份信息 (PII) 类似这些信息可能被滥用于身份盗窃: 社会安全号码, 信用卡号码, 银行账户, 健康信息
- 设备识别号可以识别个人
- 任何可以导致名誉损害或者财政损失的高敏感数据
- 任何受法律义务保护的数据
- 应用生成的任何技术数据用来保护其他数据或者系统本身数据

 必须在安全测试开始之前确定 "敏感数据" 等定义, 因为没有定义是不可能检测敏感数据的泄露.

###### 情报收集

情报收集包含应用的架构的信息收集, 应用服务器的业务使用场景, 以及应用运行的内容. 这些信息可以分为 "环境" 或者 "架构". 

###### 环境 信息

环境信息包括:

- 组织对应用程序的目标. 功能决定用户与应用程序的交互, 并有可能比其他更容易成为攻击的目标
- 相关的行业。不同的行业可能有不同的风险。
- 股东和投资者;了解谁对该应用程序感兴趣并负责。
- 内部流程、工作流程和组织结构。特定于组织的内部流程和工作流程可能为 [商业逻辑渗透](https://www.owasp.org/index.php/Testing_for_business_logic "测试商业逻辑").

###### 架构 信息

架构信息包括:

- **移动 应用:** 应用程序如何在访问数据和管理进程, 如何与其他资源通信和管理用户会话, 以及它是否检测到自己运行在越狱或者root过的手机, 并对这些情况作出反应.
- **操作系统:** 应用程序运行的操作系统和操作系统版本 (包括 Android 或者 iOS 版本的限制), 应用程序是否应该运行在有移动设备管理 (MDM) 控制的设备上, 以及操作系统的漏洞.
- **网络:** 使用安全传输协议 (e.g., TLS), 使用较强密钥 和加密算法 (e.g., SHA-2) 来保护加密网络流量, 使用证书来绑定认证的终端, 等等.
- **远程服务:** 应用程序所使用的远程服务以及是否会影响到客户端.

##### 匹配 应用功能 

安全测试人员一旦拥有了应用和内容的信息, 下一步就是匹配应用的架构和内容, 列如., 识别切入点, 功能, 和数据.

当白盒渗透测试实施当渗透测试在白盒或灰盒范例中执行时，项目内部的任何文档 (架构图, 功能图, 代码 等等)可以加大的促进这个过程. 如果存在源代码, 使用 SAST 工具可以揭示关于漏洞的有价值的信息.(e.g., SQL 注入).
DAST 工具只支持应用的黑盒测试和自动扫描: 测试人员可能需要几小时或几天的时间, 而扫描器可能在几分钟内就可以完成相同的任务. 然后, 需要记住的是, 自动工具存在局限性, 只能找到他们被编程要找到的东西. 因此, 可能需要人工分析来增强自动工具的最终结果. (直觉通常是安全测试的关键).

威胁建模是一种重要的方法: 通过讨论后的文档通常极大的给安全测试人员带来需要的信息 (入口点, 资产, 漏洞, 严重等级, 等等.). 强烈建议测试人员与客户讨论此类文档的可用性. 威胁建模是软件开发生命周期的关键部分. 它通常发生在项目的最早期阶段.

[OWASP 定义的 威胁建模指南](https://www.owasp.org/index.php/Application_Threat_Modeling "OWASP 应用 威胁模型") 是普遍适用于移动应用.

##### 漏洞利用

不幸的是, 由于时间或者财务上的限制, 许多渗透人员是通过自动扫描的方式来完成应用程序测试. (例如, 漏洞分析). 虽然在上一个阶段发现漏洞是件很有趣的事情, 但是他们的相关性必须有以下五个点来确认:

- **潜在威胁** - 漏洞利用可能造成的损害
- **重现性** - 攻击重现的难易程度
- **可利用性** - 执行攻击的容易程度
- **受影响的用户** - 受影响的用户数量
- **可发现性** - 漏洞被发现的容易程度

尽管存在种种困难, 但是有些漏洞可能无法利用, 并可能导致较小的威胁. 其他漏洞乍一看似乎是无害的, 但是在实际测试条件下却被确定为非常危险的. 测试人员通过描述漏洞及其影响来仔细的通过开发阶段来支持测试.

#### 报告

对于客户来说安全测试人员的发现只有被完整记录下来才有价值. 一份优质的渗透报告必须包括以下信息, 但不限于以下:

- 渗透内容摘要
- 范围和内容的描述 (e.g., 目标系统)
- 使用方法
- 信息来源 (包括客户提供的信息或者在渗透过程中所发行的信息)
- 优先级排序所有的发现 (e.g., 漏洞通过 DREAD 架构来分类)
- 详细的发现
- 每个缺陷的建议和修复方法

互联网上有很多渗透报告的模板: Google 是你最好的朋友!

### 安全测试 和 SDLC (软件开发生命周期)

虽然在最佳的历史中, 安全测试的远程并没有从根本上改变, 但是软件开发技术以及发生了巨大的变化. 虽然敏捷实践的广泛采用加速了软件开发, 但是安全测试人员必须变得更快, 更敏捷, 同事继续交付值得信任的软件.

下面章节将重点介绍这种演变和描叙当前的安全测试.

#### 在软件开发生命周期中的 安全测试

毕竟, 软件开发并不是很古老, 所以没有框架的开发是很容易观察到的. 许多开发人员都经历过, 他们需要最少一组规则来控制他们源代码的增长.

在过去, "瀑布流" 方法被广泛的采用: 开发按照预先定义的顺序进行. 但是仅仅局限于单个步骤, 这是瀑布方法的一个重要缺陷. 尽管他们有重要的优质功能 (比如: 提供结构, 帮助测试人员找到需要努力的痛点, 清晰和容易理解, 等.), 他们也有劣质的特性 (创建 silos, 非常缓慢, 需要专门团队, 等等.).

随着软件开发的成熟, 竞争加剧, 开发需要人员更快的对市场变化做出反应, 同时用更少的预算创建软件产品. 使用轻量级结构的想法越来越流行, 和更小的团队互相协作, 打破了整个组织的瓶颈. "敏捷" 概念衍生了其他 (Scrum, XP, 和 RAD 是敏捷实现的著名例子); 它让更多的自助团队能够更快的一起工作.

安全性最初并不是软件开发的一个组成部分. 而是一个事后的想法, 由网络运营团队执行, 他们必须弥补草稿的软件安全性! 虽然在网络边界内的软件有不集成安全的可能性, 但是随着网络, 移动和物联网技术的出现, 这种安全概念就变得过时了. 现在, 安全必须在 **内部** 软件开发中烘焙, 因为对漏洞进行弥补通常是非常困难的.

> "SDLC" 将会与下一章节中的 "安全 SDLC" 相互使用, 以帮助你理解安全是软件开发过程的一部分的概念. 本着同样的精神, 我们使用 DevSecOps 这个名称来强调安全性是 DevOps 的一部分的事实.

#### SDLC 概述

##### SDLC 的一般描述

SDLCs 总是有相同的步骤组成 (在瀑布流中, 整个过程是连续的, 而在敏捷中, 则是迭代的模式):

- 通过 **风险评估** 来识别应用和组件的风险状况. 这些风险概况通常取决于组织的风险偏好和监管要求. 风险评估基于一些因素, 包括应用程序是否可以访问互联网, 以及应用程式处理和存储数据的类型. 必须考虑的各种风险: 金融, 市场, 工厂等等. 数据分类策略指定那些数据是敏感的,以及需要被安全保护的. 
- **安全 要求** 在项目开始或者开发周期前被确定, 即收集应用功能需求的时候确定. **滥用案例** 在创建用例的时候被添加. 如果需要, 团队(包括开发团队) 可以接受安全培训 (安全代码编写). ????
你可以使用 [OWASP MASVS](https://mobile-security.gitbook.io/masvs/ "OWASP MASVS") 来确定移动应用程序在风险评估阶段的基础上的安全需求. 在添加特性和数据类时候迭代的检查需求是很正常的, 特别是在敏捷开发项目中.
- **威胁 建模**, 基本上只指 识别, 枚举, 优先级划分和对威胁的初始处理, 这些事必须作为体系结构开发和设计过程执行的基本构件.**安全 架构**, 在威胁建模之后, 可以对威胁模型模型的因素 (软件和硬件) 方面进行细化. **安全代码 规则** 有一系列的 **安全 工具** 组成, 并且被使用和被创建.这样 **安全测试** 的策略被就被明确阐明了.
- 所有的安全要求 和 设计考虑需要被保存在 应用生命周期管理系统中 (ALM),(有叫做事件跟踪平台) 这样开发/运维团队用于确保安全需求紧密的集成到开发工作流中. 安全需求应该包含相关的源代码片段, 以便开发人员可以快速的引用这些代码片段. 创建一个被版本控制的, 只包含代码片段的专用代码仓库是一种比传统方法(将指南以word 文档或者PDF 形式保存)更有效益的安全编码策略. 
- **安全的开发 软件**. 提升代码安全, 我们必须完成以下活动, 比如 **安全代码 评估**, **静态 应用安全测试(SAST)**, 和 **安全 单元测试**. 虽然这些安全任务在代码质量任务中存在, 但是同样的逻辑必须应用到安全, 例如.,审查, 分析和测试安全缺陷的代码 (缺陷代码举例, 缺少输入验证, 未能释放所有资源, 等等.).
- 接下来是期待已久的预发售测试: 手动 和 自动的 **渗透 测试** ("渗透测试"). **动态 应用安全测试(DAST)** 通常在此阶段进行..
- 当软件被所有的参与者 **认证** 和 **验收** , 就可以安全的转移到 **运营** 团队 和 投入生产.
- 最后一个阶段, 也是容易被忽略的 及当应用使用完后, 应用的 **停运(Decommissioning)** 流程.

下图展示了所有的阶段和组件:

![General description of SDLC](Images/Chapters/0x04b/SDLCOverview.jpg)

根据项目的一般风险特征, 你可以简化一些组件, 你也可以添加其他的 (正式的批准，以及某些方面的正式文件，等等.). **永远记住两件事: SDLC 是为了减低软件开发中的风险, 并且框架可以帮助我们从头到尾的控制.** 这就是对于 SDLC 的通用描述; 可以根据项目时常修剪这个框架.

##### 测试方法的确认

指定测试策略可以提升整个 SDLC 测试的评率. 测试策略的目的是为了确保最终软件产品符合安全要求, 这种要求一般是有客户, 市场/企业团队/以及立法团队决定.

测试的策略一般在 安全设计阶段 被创建, 当威胁被分类后 (在启动期间)) 和代码开发 (及安全实施阶段)之前. 这种类型的 策略 需要不同活动的输出内容, 比如: 风险管理, 威胁建模,和安全工程.

测试策略不需要正式的文本: 它有可能通过事件的模式来描述 (i在敏捷开发项目中), 快速的枚举检查列表, 或者由特定的工具来指定测试案例. 然而, 策略必须被共享因为它会被团队或者其他定义的团队实施. 更多的, 所有的技术团队必须确认不会给任何一个团队的人带来任何负担.

测试策略 涉及以下主题:

- 风险描述 和 目标
- 完成目标的计划, 风险减低, 那种测试需要强制, 谁来执行, 如何执行, 以及怎样验收.
- 验收标准

为了跟踪测试策略的流程 和 有效性, 标准应该被定义, 在项目期间不断的更新, 并定期沟通. 可以写一整本书来选择相关的度量标准; 我们这里最多只能说, 他们依赖于风险概况, 项目和组织. 度量标准的示例一般包含以下内容:

- 和安全控制相关的故事已经成功的执行/实施
- 安全控制和敏感功能的单元测试代码覆盖率
- 通过静态分析工具所找到的每个版本的安全 bug 的数量
- 安全缺陷积压的趋势 (根据紧急程度排序)

这些仅仅只是建议; 其他指标也许和你的项目更有关联. 指标是非常强大的工具, 因为它们为项目经理提供了正在发生的事情和需要改进的地方和清晰和中和的视角.

测试有内部团队 和 测被独立第三方执行的区别是重要的. 对于提高日常操作来说,内部测试非常重要, 然而第三方测试对整个组织更加有利. 内部测试可以经常进行, 但是第三方测试每年最多只进行一次到两次;而且前者比后者便宜. 

两者都是必要的, 而且许多法规要求从独立的第三方进行测试, 因为这样的测试更加值得信任.

#### 瀑布流 安全测试

##### 什么是 瀑布流 和 怎样安排测试任务

基本上，SDLC 并不要求使用任何开发生命周期：可以放心地说，安全性问题在任何情况下都可以（而且必须）被处理。

瀑布方法在21世纪之前很流行。最著名的应用程序称为"V 模型"，在其中阶段按顺序执行，并且只能回溯一个步骤。
此模型的测试活动按顺序进行，并作为一个整体执行，主要在生命周期中大多数应用开发完成时执行。此活动序列意味着，即使代码在识别缺陷后可能更改，也很难更改在项目开始时设置的体系结构和其他因素。

#### 对于 Agile/DevOps 和 DevSecOps 的安全测试

DevOps 是指侧重于参与软件开发（通常称为 Devs）和操作（通常称为运营）的所有利益相关者之间的密切合作的实践。DevOps 不是要合并开发人员和操作。
开发和操作团队最初在孤岛中工作，将开发的软件推向生产可能需要大量时间。当开发团队通过使用敏捷将更多的交付转移到生产中时，运营团队必须加快速度以跟上速度。DevOps 是解决方案应对这一挑战的必要演进，因为它允许更快地向用户发布软件。这主要通过广泛的构建自动化、测试和发布软件的过程以及基础结构更改（除了 DevOps 的协作方面）来实现。这种自动化体现在部署管道中，具有持续集成和持续交付 （CI/CD） 的概念。

P人们可能认为术语"DevOps"只代表开发和运营团队之间的协作，但是，正如 DevOps 思想领袖 Gene Kim 所说："乍一看，问题似乎只是 Devs 和 Ops 之间，但测试就在那里，您有信息安全目标，以及保护系统和数据的必要性。这些是管理层最关心的问题，它们已成为 DevOps 图片的一部分。

换句话说，DevOps 协作包括质量团队、安全团队以及与项目相关的许多其他团队。当你今天听到"DevOps"时，你也许应该想到类似 [DevOpsQATestInfoSec](https://techbeacon.com/evolution-devops-new-thinking-gene-kim "DevOps 的演变：吉恩·金关于的持续交付"). 事实上，DevOps 价值不仅与提高速度有关，还与质量、安全性、可靠性、稳定性和弹性有关。

安全性与应用程序的整体质量、性能和可用性一样，对业务成功至关重要。随着开发周期的缩短和交付频率的增加，确保质量和安全性从一开始就内置起来就变得至关重要。**DevSecOps** 是所有关于添加安全性的 DevOps 进程。大多数缺陷是在生产过程中识别的。DevOps 指定最佳做法，用于在生命周期的早期识别尽可能多的缺陷，并最大限度地减少已发布应用程序中的缺陷数量。

然而，DevSecOps不仅仅是一个线性过程，旨在向运营部门提供最好的软件;它还要求操作密切监视正在生产中的软件，通过通过开发形成快速高效的反馈循环来识别问题并修复问题。DevSecOps 是一个强调持续改进的过程。

![DevSecOps process](Images/Chapters/0x04b/DevSecOpsProcess.JPG)

这种强调的人力方面体现在创建跨职能团队，共同实现业务成果。本节重点介绍必要的交互并将安全性集成到开发生命周期中（从项目开始开始，到向用户交付价值结束）。

##### 什么是 敏捷开发(Agile) 和 DevSecOps 以及 怎样安排测试任务  and How Testing Activities Are Arranged

###### 概述

自动化是 DevSecOps 的一项关键实践：如前所述，与传统方法相比，从开发到操作的交付频率增加，并且通常需要时间才能跟上的活动，例如，提供相同的附加值而需要更多的时间。因此，必须放弃非生产性活动，必须固定基本任务。这些更改会影响基础结构更改、部署和安全性：

- 基础架构正以 **基础架构为代码** 实施
- 部署正变得更加脚本化，通过 **继续集成** 和 **持续交付** 的概念进行
- **安全活动** 正在尽可能自动化，并在整个生命周期内进行

以下各节提供了有关这三点的更多详细信息。

###### 继续架构为代码

基础架构代码不是手动预配计算资源（物理服务器、虚拟机等）和修改配置文件，而是基于使用工具和自动化来加快预配过程，使其更加可靠，重复。相应的脚本通常存储在版本控制之下，以便于共享和问题解决。

基础设施作为代码的实践可促进开发和运营团队之间的协作，结果如下：

- 开发人员从熟悉的角度更好地了解基础结构，并可以准备正在运行的应用程序所需的资源。
- Ops 操作的环境更适合应用程序，并且它们与 Devs 共享一种语言。

基础设施作为代码还有助于构建经典软件创建项目所需的环境，用于 **开发** ("DEV"), **集成** ("INT"), **测试** ("PPR" 用于预生产。某些测试通常在较早的环境中执行，PPR 测试主要涉及非回归和性能，数据与生产中使用的数据类似), 和 **生产** ("PRD"). 基础结构作为代码的价值在于环境之间的可能相似性（它们应该是相同的）。

基础结构即代码通常用于具有基于云的资源的项目，因为许多供应商提供可用于预配项目（如虚拟机、存储空间等）和配置（例如，修改内存）的 API大小或虚拟机使用的 CPU 数量）。这些 API 提供了管理员从监视控制台执行这些活动的替代方法。

此域中的主要工具是 [Puppet](https://puppet.com/ "Puppet"), [Terraform](https://www.terraform.io/ "Terraform"), [Packer](https://www.packer.io/ "Packer"), [Chef](https://www.chef.io/chef/ "Chef") and [Ansible](https://www.ansible.com/ "Ansible").

###### 开发

部署管道的复杂性取决于项目组织或开发团队的成熟度。在最简单的形式中，部署管道由提交阶段组成。提交阶段通常涉及运行简单的编译器检查和单元测试套件，以及创建应用程序的可部署项目。候选版本是已签入版本控制系统中继的最新版本。部署管道对发布候选项进行评估，以确保其符合部署到生产时必须满足的标准。

提交阶段旨在向开发人员提供即时反馈，因此在每次提交到主干时都会运行。由于此频率，存在时间限制。提交阶段通常应在五分钟内完成，并且不应超过十分钟。在安全性方面，遵守这种时间约束是相当具有挑战性的，因为许多安全工具运行速度不够快（#paul、#mcgraw）。

CI/CD 在某些上下文中表示"持续集成/持续交付"，在另一些上下文中表示"持续集成/持续部署"。实际上，逻辑是：

- 持续集成生成操作（由提交触发或定期执行）使用所有源代码生成候选版本。然后可以执行测试，并检查发布是否符合安全性、质量等规则。如果案例符合性得到确认，则该过程可以继续;否则，开发团队必须修复问题并提出更改建议。
- 持续交付候选版本可以进入预生产环境。如果随后可以验证发布（手动或自动），则可以继续部署。如果没有，项目团队将收到通知，并且必须采取适当的行动。
- 连续部署版本直接从集成过渡到生产，例如，用户可以访问它们。但是，如果在以前的活动中发现重大缺陷，则不应将任何版本用于生产。

低灵敏度或中等敏感度的应用程序的交付和部署可以合并到一个步骤中，并在交付后执行验证。但是，强烈建议敏感应用程序将这两个操作分开并使用强验证。

###### 安全

此时，最大的问题是：现在交付代码所需的其他活动已显著更快、更高效地完成，安全性如何跟上？我们如何保持适当的安全级别？以降低安全性更频繁地向用户交付价值肯定不好！

同样，答案是自动化和工具：通过在整个项目生命周期中实现这两个概念，您可以维护和提高安全性。预期安全级别越高，控制、检查点和重点就越多。以下是示例：

- 静态应用程序安全测试可以在开发阶段进行，并且可以集成到持续集成过程中，或多或少地强调扫描结果。您可以建立或多或少要求苛刻的安全编码规则，并使用 SAST 工具检查其实施的有效性。
- 动态应用程序安全测试可以在应用程序构建后（例如，在持续集成完成后）和交付之前自动执行，并再次或多或少地强调结果。
- 您可以在连续阶段之间添加手动验证检查点，例如，在交付和部署之间。

在操作过程中必须考虑使用 DevOps 开发的应用程序的安全性。以下是示例：

- 扫描应定期进行（在基础结构和应用程序级别）。
- 定期进行笔试。（生产中使用的应用程序版本是应进行笔测试的版本，测试应在专用环境中进行，并包含类似于生产版本数据的数据。有关详细信息，请参阅渗透测试部分。
- 应执行主动监视，以识别问题并通过反馈循环尽快修复问题。

![Example of a DevSecOps process](Images/Chapters/0x04b/ExampleOfADevSecOpsProcess.jpg)

### 参考资料

- [paul] - M. Paul. Official (ISC)2 Guide to the CSSLP CBK, Second Edition ((ISC)2 Press), 2014
- [mcgraw] - G McGraw. Software Security: Building Security In, 2006

#### OWASP MASVS

- V1.1："所有应用组件都已识别并已知需要。
- V1.3："移动应用和所有连接的远程服务的高级体系结构已定义，该体系结构中已解决了安全性问题。
- V1.4："在移动应用上下文中被视为敏感的数据已明确标识。
- V1.5："所有应用组件都是根据它们提供的业务功能和/或安全功能定义的。
- V1.6："已生成移动应用和相关远程服务的威胁模型，用于识别潜在威胁和对策。
- V1.7："所有安全控制都有一个集中实现。
- V1.10："安全性在软件开发生命周期的所有部分都得到解决。